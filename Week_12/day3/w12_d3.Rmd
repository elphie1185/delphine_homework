---
title: "R Notebook"
output: html_notebook
---


Libraries you’ll need:
```{r}
library(zoo)
library(xts)
library(lubridate)
library(tseries)
library(forecast)
library(tibbletime)
library(timetk)
library(tidyverse)
```


MVP
Question 1
Load in the sunspots data and check it is a time series. Get the start and end times, periodicity, frequency, and anything else you need to understand your data.


```{r}
start(sunspots)
end(sunspots)
class(sunspots)
frequency(sunspots)
cycle(sunspots)
```

```{r}
boxplot(sunspots)
```


```{r}
sunspots_ts <- ts(sunspots, frequency = 12, start = c(1749, 1))
plot.ts(sunspots_ts)
```

```{r}
plot(aggregate(sunspots), fun = mean)

```

Question 2
Write an initial description of your data. Give enough detail that you could use it as a description for a data dictionary or for another analyst to follow.

# The general trend of the timeseries is variable - no particular increase or decrease as the aggregate of the mean shows above.

# The plot of the time serie shows a repeating pattern every 10 years with different intensity - the data appears to be seasonal.



Question 3
Calculate the rolling average of your sunspots data, and plot it. 

```{r}
rolling_av <- rollapply(sunspots_ts, width = 240, align = "right", 
                        FUN = mean, na.rm = TRUE)

sunspots_rolling <- cbind(sunspots_ts, rolling_av)
plot(sunspots_rolling)
```

We can see that the rolling average varies over time - there is no particular trend.


Question 4
Decompose the time series and look at the different components. Make sure you use the right type of decomposition. Then take a look at your different components. What does it all tell you? 

```{r}
sunspots_decomp <- decompose(sunspots_ts, type = "additive")
plot(sunspots_decomp)
```

Looking at each plots individually
```{r}
plot(sunspots_decomp$trend)
```
This confirms that there is no particular trend in the datasets

```{r}
plot(sunspots_decomp$random)
```

We can see that the noise is random.
```{r}
sunspots_unlist <- as_tibble(unlist(sunspots_decomp$seasonal))
sunspots_fifty <- sunspots_unlist[1:100, ]

ggplot(sunspots_fifty) +
  aes(x = seq(1, 100, 1), y = x) +
  geom_line()
```

In the plt above we can see the seasonality of the dataset over 100 years.


Question 5
Check if your data is stationary using the appropriate plots. Do you have stationary data? If no, make the data stationary.

```{r}
# We already know that the year on year mean trend - there is no particular trend -> stationary

plot(aggregate(sunspots), fun = mean)
```

```{r}
# We can see a similar trend season on season - 

boxplot(sunspots_ts~cycle(sunspots_ts))
```

```{r}
adf.test(sunspots_ts, alternative="stationary", k=0)
```

p_value is low, we can reject the null hypothesis and confirm that the data is sationary.


Question 6
Now we have our data, choose your ARIMA model parameters. Create ACF and PACF plots to check, and write a summary of what you have found.


```{r}
arimaAP <- auto.arima(sunspots_ts, approximation = FALSE)
arimaAP
```

```{r}
acf(sunspots_ts)
```

I must have missed something here....



```{r}
pacf(sunspots_ts)
```

Question 7
Fit an ARIMA model that predicts the sunspots for the next 20 years. Plot the data, and have a look at your forecast. Does it look like a good forecast or good fit?
```{r}
model_1 <- arima(sunspots_ts, c(2,1,2),seasonal = list(order = c(2,1,2), period = 12))
model_1
```


```{r}
# checking the residuals
checkresiduals(model_1)
```

There seem to be an issue with the model although the residuals plot look ok

```{r}
predictions <- predict(model_1, n.ahead = 20*12)

# plot the air passengers data, along with the predicted data
ts.plot(sunspots, predictions$pred, lty = c(1,3))
```

Definitly doesn't look like a good model


Question 8
Problem solving: Your model isn’t predicting that well. What are some reasons you can think for this?
```{r}
# From the acf graph we can see that everything seem to be significant. 
# There must be some ynderlying correlation that I have forgotten about.
```


Question 9
Problem solving:

In the present case, sunspots have a cycle of length 11 years. To know this, you’d have to know something about sunspots. You can find this here. The sunspots data are a monthly time series. Thus, the implicit seasonality of sunspots is 12 (months), not 11×12=132 (months).

ARIMA and auto.arima() were never built to automatically detect a seasonal cycle whose length is not pre-specified. It is not overly surprising it does not see that it should do 11 seasonal differences to model a seasonality that repeats every 11 cycles of its prespecified frequency.

So, the first order of business would be to specify that seasonal cycles are indeed of length 132 (i.e. 1112). Then you’ll need to use this seasonally adjusted data in your model, and include a seasonality parameter into your arima model (try ?auto.arima) to show how to do this. Hint, it involves setting your D parameter = 1*. Then you can plot your data and predict the next 20 years. Is this a better fit?




Extensions
Question 1
The dataset, sunspot.month is a ts class, rather than a classic tidy tibble. Using your knowledge of tidyverse and ts objects, convert the sunspot.month data to a tidy data set using the tk_tbl() function from timetk package. Using this instead of as.tibble() (from the tibble package) is better because it automatically preserves the time series index.

Then, convert the index to date using lubridate::as_date() and then change to a tbl_time object (from the tibbletime package).

Then summarise the median value of sunspots in the year 1980. Hint: you’ll have to combine your knowledge of how to filter and summarise dates and times in tidyverse to do this.

Question 2
Get and load the package ‘xts’ and all required packages. Create the objects ‘measurment’ and ‘dates’ like below.

measurement <- rep(sin(seq(0,10,length.out = 90)),4) + rnorm(90*4)
dates <- seq(as.Date("1987-01-01"), as.Date("1987-12-26"), "day")
Use the two objects to create an xts time series (mytimeseries) ordered by dates. Check the class, structure, number of years, months and quarters. Get the core data and index as well, and check these are matrix and index data.

Select all of the August to September data in your xts object. Plot this new xts time series.Use apply.monthly from xts to get a monthly mean on the time series. Finally, get a monthly plot.