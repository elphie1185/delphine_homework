---
title: "R Notebook"
output: html_notebook
---

You are given a set of data on housing sale prices for the last few years in King County (near Seattle) between May 2014 and May 2015. Have a look at the variable definitions on the Kaggle page

Tidy up the data ready for regression:
```{r}
library(tidyverse)
library(readr)
library(lubridate)
```

```{r}
house <- read_csv("kc_house_data.csv")
summary(house)
```


You might like to think about removing some or all of date, id, sqft_living15, sqft_lot15 and zipcode (lat and long provide a better measure of location in any event).
```{r}
house_trim <- house %>%
  select(-id) %>%
  select(-date) %>%
  select(-zipcode) %>%
  select(-sqft_living15) %>%
  select(-sqft_lot15)
```

Have a think about how to treat waterfront. Should we convert its type? NO
```{r}
unique(house_trim$waterfront)
```

We converted yr_renovated into a renovated logical variable, indicating whether the property had ever been renovated. You may wish to do the same.
```{r}
house_boolean <- house_trim %>%
  mutate(renovated = as.numeric(yr_renovated != 0)) %>%
  select(-yr_renovated)

colnames(house_boolean)
```

Have a think about how to treat condition and grade? Are they interval or categorical ordinal data types?
```{r}
unique(house_boolean$condition)
unique(house_boolean$grade)
```

Check for aliased variables using the alias() function (this takes in a formula object and a data set). 
```{r}
alias(price ~ ., 
      data = house_boolean)
```
square foot living and above highly correlated to sqft_basement - let's 
remove them
```{r}
house_bool <- house_boolean %>%
  select(-sqft_basement) %>%
  select(-sqft_above)
```


Systematically build a regression model containing up to four main effects (remember, a main effect is just a single predictor with coefficient), testing the regression diagnostics as you go splitting datasets into numeric and non-numeric columns might help ggpairs() run in manageable time, although you will need to add either a price or resid column to the non-numeric dataframe in order to see its correlations with the non-numeric predictors.
```{r}
library(modelr)
library(GGally)
house_num <- subset(house_bool, select = c("price", "bedrooms", "bathrooms", 
                                              "sqft_living", "floors", 
                                              "lat", "long"))
house_cat <- subset(house_bool, select = c("waterfront", "view", "condition", 
                                              "grade", "renovated", "price"))

```

```{r}
ggpairs(house_num)
```

```{r}
ggpairs(house_cat)
```

1st model
```{r}
mod1a_sqft <- lm(price ~ sqft_living, 
                data = house_bool)

mod1b_grade <- lm(price ~ grade, 
                  data = house_bool)

summary(mod1a_sqft)
plot(mod1a_sqft)
```

```{r}
summary(mod1b_grade)
plot(mod1b_grade)
```

see if log fixes it (one by one and then both):
```{r}
plot_1c_log <- mod1a_sqft <- lm(log(price) ~ log(sqft_living), 
                data = house_bool)
summary(plot_1c_log)
```
not really...

```{r}
cor(house_bool$sqft_living, house_bool$grade)
```
high correlation between the sqft_living and the grade. Grade will not be added to the model

Let's check with anova
```{r}
mod1a_sqft_grade <- lm(price ~ sqft_living + grade, 
                       data = house_bool)
anova(mod1a_sqft, mod1a_sqft_grade)
```

We could use it
```{r}
summary(mod1a_sqft_grade)
```

but not much improvement in the R-squared

```{r}
house_num_2 <- house_num %>%
  add_residuals(mod1a_sqft) %>%
  select(-c("price", "sqft_living"))
ggpairs(house_num_2)

```

```{r}
house_cat_2 <- house_bool %>%
  add_residuals(mod1a_sqft) %>%
  select(-c("price", "bedrooms", "bathrooms", "sqft_living", 
            "floors", "lat", "long", "grade"))
ggpairs(house_cat_2)
  
```

Latitude and view have the best correlation with the residuals: 
```{r}
mod2_sqft_lat <- lm(price ~ sqft_living + lat, 
                    data = house_bool)

mod2_sqft_view <- lm(price ~ sqft_living + view, 
                     data = house_bool)

summary(mod2_sqft_lat)
plot(mod2_sqft_lat)
```

```{r}
summary(mod2_sqft_view)
plot(mod2_sqft_view)
```

Looks like latitude is the best
Is there a correlation between latitude and view?
```{r}
cor(house_bool$lat, house_bool$view)
```

not really - let see if we can improve the model with the view: 
```{r}
mod3_sqft_lat_view <- lm(price ~ sqft_living + lat + view, 
                    data = house_bool)
summary(mod3_sqft_lat_view)
```

Hurray!!
Let see what else to use
```{r}
house_3 <- house_bool %>%
  add_residuals(mod3_sqft_lat_view) %>%
  select(-c("price", "grade", "lat", "view"))
ggpairs(house_3)
```
Waterfront looks good so let's go with that
```{r}
mod_4 <- lm(price ~ sqft_living + lat + view + waterfront,  
                    data = house_bool)
summary(mod_4)
```

not much added value - let's try with the next best :year_build
```{r}
mod_4b <- lm(price ~ sqft_living + lat + view + yr_built,  
                    data = house_bool)
summary(mod_4b)
```

nope! mod_4 is still the best


2 Extensions
Consider possible interactions between your four main effect predictors and test their effect upon r2. Choose your best candidate interaction and visualise its effect.
mod_4 <- lm(price ~ sqft_living + lat + view + waterfront,  
                    data = house_bool)
```{r}
mod5_a <- lm(price ~ sqft_living + lat + view + waterfront + sqft_living:waterfront,  
                    data = house_bool)
mod5_b <- lm(price ~ sqft_living + lat + view + waterfront + waterfront:view,  
                    data = house_bool)

summary(mod5_a)
summary(mod5_b)

```
                    
```{r}
house_bool %>%
  ggplot(aes(x = sqft_living, y = price, colour = waterfront)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

```


Calculate the relative importance of predictors from your best 4-predictor model (i.e. the model without an interaction). Which predictor affects price most strongly?
```{r}
library(relaimpo)
calc.relimp(mod_4, type = "lmg", rela = TRUE)

```


sqft_living affects the price most strongly